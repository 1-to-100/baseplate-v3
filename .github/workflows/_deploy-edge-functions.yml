name: Deploy Edge Functions

on:
  workflow_call:
    inputs:
      deploy_all:
        description: Deploy all functions (ignore change detection)
        type: boolean
        default: false
      include_app_functions:
        description: Include feature functions from src/app
        type: boolean
        default: false
    secrets:
      SUPABASE_ACCESS_TOKEN:
        required: true
    outputs:
      deployed_functions:
        description: List of deployed functions
        value: ${{ jobs.deploy.outputs.functions }}

env:
  APPLICATION_REPO: ${{ vars.APPLICATION_REPO || 'false' }}

jobs:
  deploy:
    name: Deploy Functions
    runs-on: ubuntu-latest
    environment: production
    outputs:
      functions: ${{ steps.changed.outputs.functions }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        if: env.APPLICATION_REPO == 'true' || inputs.include_app_functions == true
        uses: ./.github/actions/setup-node
        with:
          cache: 'false'

      - name: Wrap feature functions
        if: env.APPLICATION_REPO == 'true' || inputs.include_app_functions == true
        run: node supabase/scripts/wrap-feature-functions.mjs

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: supabase link --project-ref ${{ vars.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Get changed functions
        id: changed
        run: |
          BASE_FUNCTIONS="user-management auth-context admin-operations team-management"

          IS_APPLICATION_REPO="${{ env.APPLICATION_REPO }}"
          if [[ "${{ inputs.include_app_functions }}" == "true" ]]; then
            IS_APPLICATION_REPO="true"
          fi

          echo "Include app functions: $IS_APPLICATION_REPO"

          if [[ "${{ inputs.deploy_all }}" == "true" ]]; then
            echo "Deploying all functions"
            if [[ "$IS_APPLICATION_REPO" == "true" ]]; then
              ALL_FUNCTIONS=$(ls -d supabase/functions/*/ 2>/dev/null | xargs -n1 basename | grep -v "^_" | tr '\n' ' ')
              echo "functions=$ALL_FUNCTIONS" >> $GITHUB_OUTPUT
            else
              echo "functions=$BASE_FUNCTIONS" >> $GITHUB_OUTPUT
            fi
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q "supabase/functions/_shared/"; then
            echo "Shared code changed - deploying all eligible functions"
            if [[ "$IS_APPLICATION_REPO" == "true" ]]; then
              ALL_FUNCTIONS=$(ls -d supabase/functions/*/ 2>/dev/null | xargs -n1 basename | grep -v "^_" | tr '\n' ' ')
              echo "functions=$ALL_FUNCTIONS" >> $GITHUB_OUTPUT
            else
              echo "functions=$BASE_FUNCTIONS" >> $GITHUB_OUTPUT
            fi
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          FUNCTIONS=""

          for file in $CHANGED_FILES; do
            if [[ $file =~ supabase/functions/([^/]+)/ ]]; then
              fn="${BASH_REMATCH[1]}"
              if [[ $fn == _* ]]; then
                continue
              fi
              if [[ " $BASE_FUNCTIONS " =~ " $fn " ]] || [[ "$IS_APPLICATION_REPO" == "true" ]]; then
                if [[ ! " $FUNCTIONS " =~ " $fn " ]]; then
                  FUNCTIONS="$FUNCTIONS $fn"
                fi
              fi
            fi
          done

          if [[ "$IS_APPLICATION_REPO" == "true" ]]; then
            for file in $CHANGED_FILES; do
              if [[ $file =~ src/app/.*/lib/edge/([^/]+)/ ]]; then
                fn="${BASH_REMATCH[1]}"
                if [[ ! " $FUNCTIONS " =~ " $fn " ]]; then
                  FUNCTIONS="$FUNCTIONS $fn"
                fi
              fi
            done
          fi

          FUNCTIONS=$(echo "$FUNCTIONS" | xargs)

          echo "Functions to deploy: $FUNCTIONS"
          echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT

          if [[ -z "$FUNCTIONS" ]]; then
            echo "No function changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy changed functions
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          for fn in ${{ steps.changed.outputs.functions }}; do
            echo "Deploying function: $fn"
            supabase functions deploy "$fn"
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
