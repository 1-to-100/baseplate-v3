name: Check for Edge Function Wrappers

on:
  pull_request:
    paths:
      - 'supabase/functions/**'

jobs:
  check-wrappers:
    # Only run if NOT an application repo
    if: vars.APPLICATION_REPO != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for wrapper files
        id: check
        run: |
          # Discover all feature functions from src/app/**/lib/edge/
          echo "Discovering feature functions from src/app..."
          FEATURE_FUNCTIONS=$(find src/app -type d -path "*/lib/edge/*" -exec basename {} \; 2>/dev/null | sort -u || true)

          echo "Feature functions found:"
          echo "$FEATURE_FUNCTIONS"
          echo ""

          # Get changed files in supabase/functions/
          CHANGED_FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only | grep "^supabase/functions/" || true)

          echo "Changed files in supabase/functions/:"
          echo "$CHANGED_FILES"
          echo ""

          WRAPPER_FILES=""

          for file in $CHANGED_FILES; do
            # Extract function name from path (supabase/functions/<name>/...)
            fn=$(echo "$file" | sed -n 's|supabase/functions/\([^/]*\)/.*|\1|p')

            # Skip empty
            if [[ -z "$fn" ]]; then
              continue
            fi

            # Check if this function name matches a feature function
            if echo "$FEATURE_FUNCTIONS" | grep -qx "$fn"; then
              WRAPPER_FILES="$WRAPPER_FILES- \`$file\` (wrapper for feature function \`$fn\`)\n"
            fi
          done

          if [[ -n "$WRAPPER_FILES" ]]; then
            echo "found=true" >> $GITHUB_OUTPUT
            # Use a delimiter for multiline output
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$WRAPPER_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Comment on PR
        if: steps.check.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const files = `${{ steps.check.outputs.files }}`;
            const body = `## ⚠️ Edge Function Wrapper Files Detected

            The following files are wrappers for feature functions and should not be committed in non-application repos:

            ${files}

            **Please remove these files from your PR.**

            ### Why?
            - These wrappers are auto-generated by \`supabase/scripts/wrap-feature-functions.mjs\`
            - They simply re-export code from \`src/app/**/lib/edge/\`
            - The CI/CD pipeline generates them at deploy time when \`APPLICATION_REPO=true\`
            - Committing them causes unnecessary merge conflicts and drift

            ### What to do
            1. Remove these files from your commit
            2. Ensure your feature function source code in \`src/app/**/lib/edge/\` is committed instead`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if wrappers found
        if: steps.check.outputs.found == 'true'
        run: |
          echo "::error::Feature function wrapper files detected in PR. Please remove them."
          exit 1
