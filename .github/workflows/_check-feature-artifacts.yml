name: Check Feature Artifacts

on:
  workflow_call:
    inputs:
      pr_number:
        description: Pull request number
        type: number
        required: true

jobs:
  check-feature-artifacts:
    name: Check Feature Artifacts
    if: vars.APPLICATION_REPO != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================================================
      # Check 1: Feature edge function wrappers in supabase/functions/
      # =========================================================
      - name: Check for wrapper files
        id: check-wrappers
        run: |
          echo "Discovering feature functions from src/app..."
          FEATURE_FUNCTIONS=$(find src/app -type d -path "*/lib/edge/*" -exec basename {} \; 2>/dev/null | sort -u || true)

          echo "Feature functions found:"
          echo "$FEATURE_FUNCTIONS"

          CHANGED_FILES=$(gh pr diff ${{ inputs.pr_number }} --name-only | grep "^supabase/functions/" || true)

          echo "Changed files in supabase/functions/:"
          echo "$CHANGED_FILES"

          WRAPPER_FILES=""

          for file in $CHANGED_FILES; do
            fn=$(echo "$file" | sed -n 's|supabase/functions/\([^/]*\)/.*|\1|p')

            if [[ -z "$fn" ]]; then
              continue
            fi

            if echo "$FEATURE_FUNCTIONS" | grep -qx "$fn"; then
              WRAPPER_FILES="$WRAPPER_FILES- \`$file\` (wrapper for feature function \`$fn\`)\n"
            fi
          done

          if [[ -n "$WRAPPER_FILES" ]]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$WRAPPER_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      # =========================================================
      # Check 2: Feature migration symlinks in supabase/migrations/
      # Double-underscore convention: <timestamp>__<feature>__<name>.sql
      # =========================================================
      - name: Check for feature migrations
        id: check-migrations
        run: |
          CHANGED_FILES=$(gh pr diff ${{ inputs.pr_number }} --name-only | grep "^supabase/migrations/" || true)

          echo "Changed files in supabase/migrations/:"
          echo "$CHANGED_FILES"

          # Match the double-underscore naming convention:
          # <14-digit-timestamp>__<feature-slug>__<migration-name>.sql
          FEATURE_MIGRATIONS=""

          for file in $CHANGED_FILES; do
            basename=$(basename "$file")
            if echo "$basename" | grep -qE '^[0-9]{14}__[^_].*__.+\.sql$'; then
              FEATURE_MIGRATIONS="$FEATURE_MIGRATIONS- \`$file\`\n"
            fi
          done

          if [[ -n "$FEATURE_MIGRATIONS" ]]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$FEATURE_MIGRATIONS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      # =========================================================
      # Check 3: Auto-generated response processor registry
      # =========================================================
      - name: Check for generated registry
        id: check-registry
        run: |
          # `gh pr diff --name-only` has no status information. Use the PR files API
          # so deletions of the generated registry file do not fail this check.
          REGISTRY_STATUSES=$(gh api "repos/${{ github.repository }}/pulls/${{ inputs.pr_number }}/files" \
            --paginate \
            --jq '.[] | select(.filename == "supabase/functions/_shared/response-processors/registry.ts") | .status' \
            || true)

          echo "Registry file statuses:"
          echo "$REGISTRY_STATUSES"

          REGISTRY_VIOLATION=false
          while IFS= read -r status; do
            if [[ -n "$status" && "$status" != "removed" ]]; then
              REGISTRY_VIOLATION=true
              break
            fi
          done <<< "$REGISTRY_STATUSES"

          echo "found=$REGISTRY_VIOLATION" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      # =========================================================
      # Comment and fail if any feature artifacts were found
      # =========================================================
      - name: Comment on PR
        if: steps.check-wrappers.outputs.found == 'true' || steps.check-migrations.outputs.found == 'true' || steps.check-registry.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const wrapperFiles = `${{ steps.check-wrappers.outputs.files }}`;
            const migrationFiles = `${{ steps.check-migrations.outputs.files }}`;
            const hasWrappers = `${{ steps.check-wrappers.outputs.found }}` === 'true';
            const hasMigrations = `${{ steps.check-migrations.outputs.found }}` === 'true';
            const hasRegistry = `${{ steps.check-registry.outputs.found }}` === 'true';

            let body = `## ⚠️ Feature Artifacts Detected\n\n`;
            body += `This repository is a **platform repo** (\`APPLICATION_REPO != true\`). `;
            body += `Feature-specific generated files should not be committed here.\n\n`;

            if (hasWrappers) {
              body += `### Edge Function Wrappers\n\n`;
              body += `The following wrapper files were detected:\n\n`;
              body += wrapperFiles + `\n`;
              body += `These are auto-generated by \`pnpm supabase:wrap-functions\` and re-export code from \`src/app/**/lib/edge/\`.\n\n`;
            }

            if (hasMigrations) {
              body += `### Feature Migration Symlinks\n\n`;
              body += `The following feature migration files were detected:\n\n`;
              body += migrationFiles + `\n`;
              body += `These are auto-generated by \`pnpm supabase:link-migrations\` and symlink to SQL in \`src/app/**/lib/sql/\`.\n\n`;
            }

            if (hasRegistry) {
              body += `### Response Processor Registry\n\n`;
              body += `- \`supabase/functions/_shared/response-processors/registry.ts\`\n\n`;
              body += `This file is auto-generated by \`pnpm supabase:wrap-functions\` from \`response-processor.ts\` files in \`src/app/**/lib/edge/\`.\n\n`;
            }

            body += `### Why?\n\n`;
            body += `Feature artifacts use a **double-underscore naming convention** (\`__feature-slug__\`) to distinguish them from core baseplate files. `;
            body += `They are generated at dev time (or deploy time when \`APPLICATION_REPO=true\`) and should not be committed to the platform repo because:\n\n`;
            body += `- They cause unnecessary merge conflicts and drift\n`;
            body += `- The CI/CD pipeline generates them at deploy time for application repos\n`;
            body += `- Source-of-truth lives in \`src/app/(scalekit)/<feature>/lib/sql/\` and \`src/app/(scalekit)/<feature>/lib/edge/\`\n\n`;
            body += `### What to do\n\n`;
            body += `Remove these files from your commit. The feature source code in \`src/app/\` is all that needs to be committed.\n`;

            github.rest.issues.createComment({
              issue_number: ${{ inputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if feature artifacts found
        if: steps.check-wrappers.outputs.found == 'true' || steps.check-migrations.outputs.found == 'true' || steps.check-registry.outputs.found == 'true'
        run: |
          echo "::error::Feature artifacts detected in PR. Please remove generated wrapper files, migration symlinks, and the response processor registry."
          exit 1
