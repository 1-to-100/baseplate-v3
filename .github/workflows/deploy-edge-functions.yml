name: Deploy Edge Functions

on:
  workflow_run:
    workflows: ["Deno Edge Function Tests"]
    types:
      - completed
    branches:
      - master
      - main
  workflow_dispatch:
    inputs:
      deploy_all:
        description: 'Deploy all functions (ignore change detection)'
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if tests passed (or manual trigger)
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # For workflow_run, checkout the commit that triggered the test workflow
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Wrap feature functions
        run: node supabase/scripts/wrap-feature-functions.mjs

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Get changed functions
        id: changed
        run: |
          if [[ "${{ github.event.inputs.deploy_all }}" == "true" ]]; then
            echo "Deploying all functions (manual trigger with deploy_all=true)"
            echo "deploy_all=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get changed files between HEAD and previous commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Check if _shared was modified - if so, deploy all functions
          if echo "$CHANGED_FILES" | grep -q "supabase/functions/_shared/"; then
            echo "Shared code changed - deploying all functions"
            echo "deploy_all=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract function names from changed paths
          FUNCTIONS=""

          # From src/app/**/lib/edge/<function-name>/**
          for file in $CHANGED_FILES; do
            if [[ $file =~ src/app/.*/lib/edge/([^/]+)/ ]]; then
              fn="${BASH_REMATCH[1]}"
              if [[ ! " $FUNCTIONS " =~ " $fn " ]]; then
                FUNCTIONS="$FUNCTIONS $fn"
              fi
            fi
          done

          # From supabase/functions/<function-name>/**
          for file in $CHANGED_FILES; do
            if [[ $file =~ supabase/functions/([^/]+)/ ]]; then
              fn="${BASH_REMATCH[1]}"
              # Skip _shared directory
              if [[ $fn != "_shared" ]] && [[ ! " $FUNCTIONS " =~ " $fn " ]]; then
                FUNCTIONS="$FUNCTIONS $fn"
              fi
            fi
          done

          # Trim leading space
          FUNCTIONS=$(echo "$FUNCTIONS" | xargs)

          echo "Functions to deploy: $FUNCTIONS"
          echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT

          if [[ -z "$FUNCTIONS" ]]; then
            echo "No function changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy changed functions
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          for fn in ${{ steps.changed.outputs.functions }}; do
            echo "Deploying function: $fn"
            supabase functions deploy "$fn" --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy all functions
        if: steps.changed.outputs.deploy_all == 'true'
        run: supabase functions deploy --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
