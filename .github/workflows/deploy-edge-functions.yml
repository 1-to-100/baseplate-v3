name: Deploy Edge Functions

on:
  workflow_run:
    workflows: ["Deno Edge Function Tests"]
    types:
      - completed
    branches:
      - master
      - main
  workflow_dispatch:
    inputs:
      deploy_all:
        description: 'Deploy all functions (ignore change detection)'
        type: boolean
        default: false
      include_app_functions:
        description: 'Include feature functions from src/app (application repo mode)'
        type: boolean
        default: false

env:
  # Read from GitHub repository variable (Settings > Secrets and variables > Actions > Variables)
  # Set APPLICATION_REPO=true for application repos (includes feature functions from src/app/**/lib/edge/)
  APPLICATION_REPO: ${{ vars.APPLICATION_REPO || 'false' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if tests passed (or manual trigger)
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # For workflow_run, checkout the commit that triggered the test workflow
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 2

      - name: Setup Node.js
        if: env.APPLICATION_REPO == 'true' || github.event.inputs.include_app_functions == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Wrap feature functions
        if: env.APPLICATION_REPO == 'true' || github.event.inputs.include_app_functions == 'true'
        run: node supabase/scripts/wrap-feature-functions.mjs

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Get changed functions
        id: changed
        run: |
          # Base functions (always eligible for deployment)
          BASE_FUNCTIONS="user-management auth-context admin-operations team-management"

          # Determine if we're including app functions
          IS_APPLICATION_REPO="${{ env.APPLICATION_REPO }}"
          if [[ "${{ github.event.inputs.include_app_functions }}" == "true" ]]; then
            IS_APPLICATION_REPO="true"
          fi

          echo "Include app functions: $IS_APPLICATION_REPO"

          # Handle deploy_all flag
          if [[ "${{ github.event.inputs.deploy_all }}" == "true" ]]; then
            echo "Deploying all functions (manual trigger with deploy_all=true)"
            if [[ "$IS_APPLICATION_REPO" == "true" ]]; then
              # Deploy all functions in supabase/functions/
              ALL_FUNCTIONS=$(ls -d supabase/functions/*/ 2>/dev/null | xargs -n1 basename | grep -v "^_" | tr '\n' ' ')
              echo "functions=$ALL_FUNCTIONS" >> $GITHUB_OUTPUT
            else
              echo "functions=$BASE_FUNCTIONS" >> $GITHUB_OUTPUT
            fi
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get changed files between HEAD and previous commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Check if _shared was modified - if so, deploy all eligible functions
          if echo "$CHANGED_FILES" | grep -q "supabase/functions/_shared/"; then
            echo "Shared code changed - deploying all eligible functions"
            if [[ "$IS_APPLICATION_REPO" == "true" ]]; then
              ALL_FUNCTIONS=$(ls -d supabase/functions/*/ 2>/dev/null | xargs -n1 basename | grep -v "^_" | tr '\n' ' ')
              echo "functions=$ALL_FUNCTIONS" >> $GITHUB_OUTPUT
            else
              echo "functions=$BASE_FUNCTIONS" >> $GITHUB_OUTPUT
            fi
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract function names from changed paths
          FUNCTIONS=""

          # From supabase/functions/<function-name>/**
          for file in $CHANGED_FILES; do
            if [[ $file =~ supabase/functions/([^/]+)/ ]]; then
              fn="${BASH_REMATCH[1]}"
              # Skip _shared directory
              if [[ $fn == _* ]]; then
                continue
              fi
              # Check if it's a base function or if we're including app functions
              if [[ " $BASE_FUNCTIONS " =~ " $fn " ]] || [[ "$IS_APPLICATION_REPO" == "true" ]]; then
                if [[ ! " $FUNCTIONS " =~ " $fn " ]]; then
                  FUNCTIONS="$FUNCTIONS $fn"
                fi
              fi
            fi
          done

          # From src/app/**/lib/edge/<function-name>/** (only if including app functions)
          if [[ "$IS_APPLICATION_REPO" == "true" ]]; then
            for file in $CHANGED_FILES; do
              if [[ $file =~ src/app/.*/lib/edge/([^/]+)/ ]]; then
                fn="${BASH_REMATCH[1]}"
                if [[ ! " $FUNCTIONS " =~ " $fn " ]]; then
                  FUNCTIONS="$FUNCTIONS $fn"
                fi
              fi
            done
          fi

          # Trim leading space
          FUNCTIONS=$(echo "$FUNCTIONS" | xargs)

          echo "Functions to deploy: $FUNCTIONS"
          echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT

          if [[ -z "$FUNCTIONS" ]]; then
            echo "No function changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy changed functions
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          for fn in ${{ steps.changed.outputs.functions }}; do
            echo "Deploying function: $fn"
            supabase functions deploy "$fn" --import-map deno.json
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
