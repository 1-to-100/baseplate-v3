name: Database Tests (pgTAP)

on:
  workflow_call:

jobs:
  test:
    name: Run pgTAP Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase (DB only)
        run: supabase start -x realtime,storage,imgproxy,inbucket,postgrest,pgadmin-schema-diff,migra,studio,edge-runtime,logflare,vector,supavisor

      - name: Create test results directory
        run: mkdir -p test-results

      - name: Run pgTAP database tests
        id: db-tests
        continue-on-error: true
        run: |
          set -euo pipefail
          shopt -s nullglob

          DB_URL="postgresql://postgres:postgres@127.0.0.1:54322/postgres"
          RAW_OUTPUT_FILE="test-results/psql-output.txt"
          TAP_OUTPUT_FILE="test-results/tap-output.txt"
          : > "$RAW_OUTPUT_FILE"

          test_files=(supabase/tests/*.test.sql)
          if [ ${#test_files[@]} -eq 0 ]; then
            echo "::error::No pgTAP SQL test files found in supabase/tests"
            exit 1
          fi

          for f in "${test_files[@]}"; do
            echo "Running pgTAP SQL file: $f"
            psql "$DB_URL" -X -t -v ON_ERROR_STOP=1 -f "$f" | tee -a "$RAW_OUTPUT_FILE"
          done

          if ! grep -E '^\s*(ok |not ok |1\.\.|#)' "$RAW_OUTPUT_FILE" | sed 's/^ *//' > "$TAP_OUTPUT_FILE"; then
            # grep returns 1 when there are no TAP lines; handled by explicit empty-file check below.
            :
          fi

          if [ ! -s "$TAP_OUTPUT_FILE" ]; then
            echo "::error::No TAP output produced by pgTAP runner"
            exit 1
          fi

          # Fail if any tests failed
          if grep -q '^not ok' "$TAP_OUTPUT_FILE"; then
            echo "::error::pgTAP tests have failures"
            exit 1
          fi

      - name: Convert TAP to JUnit XML
        if: always()
        run: |
          npx tap-junit --input test-results/tap-output.txt --output test-results --name db-tests || true

      - name: Create fallback test report
        if: always() && steps.db-tests.outcome == 'failure'
        run: |
          if [ ! -f test-results/db-tests.xml ]; then
            cat > test-results/db-tests.xml << 'XMLEOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <testsuites>
            <testsuite name="Database Tests (pgTAP)" tests="1" failures="1" errors="0">
              <testcase name="Test Suite Execution" classname="supabase.test.db">
                <failure message="Test runner crashed">The pgTAP test runner failed before producing TAP output. Check the workflow log for details.</failure>
              </testcase>
            </testsuite>
          </testsuites>
          XMLEOF
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: db-test-results
          path: test-results/db-tests.xml
          retention-days: 30
          if-no-files-found: warn

      - name: Publish test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Database Tests (pgTAP)
          path: test-results/db-tests.xml
          reporter: java-junit

      - name: Stop Supabase
        if: always()
        run: supabase stop

      - name: Fail job if tests failed
        if: always() && steps.db-tests.outcome == 'failure'
        run: exit 1
